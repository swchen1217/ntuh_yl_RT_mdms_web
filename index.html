<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫療儀器管理系統</title>

    <!--  jQuery -->
    <script src="jquery-3.4.1.js"></script>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <script src="bootstrap/js/bootstrap.js"></script>
    <!-- Popper.js -->
    <script src="popper.min.js"></script>
    <!-- jQuery-confirm -->
    <link rel="stylesheet" href="jquery-confirm-v3.3.4/jquery-confirm.min.css">
    <script src="jquery-confirm-v3.3.4/jquery-confirm.min.js"></script>
    <!-- jQuery-cookie -->
    <script src="jquery-cookie/jquery.cookie.js"></script>
    <!-- FontAwesome -->
    <link href="css/all.css" rel="stylesheet">
    <!-- w3 -->
    <script src="w3.js"></script>

    <!-- My CSS -->
    <link rel="stylesheet" href="main.css">
    <!-- My js -->
    <script src="alert.js"></script>
</head>
<body>
<div class="jumbotron text-center" style="margin-bottom:0;padding-top: 20px;padding-bottom: 20px;">
    <div class="container">
        <h1>NTUH.YL 醫療儀器管理系統</h1>
        <h4>NTUH.YL Medical Device Manage System</h4>
    </div>
</div>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark" style="padding: 0px">
    <button class="navbar-toggler" data-toggle="collapse" data-target="#navbarToggler" style="margin-left: 16px">
        <span class="navbar-toggler-icon">
        </span>
    </button>
    <a class="navbar-brand" href="index.html" style="margin-right: 16px;margin-left: 16px">MDMS</a>

    <div class="collapse navbar-collapse" id="navbarToggler">
        <ul class="nav navbar-nav mr-auto">
            <li>
                <a class="nav-link" href="#UpdateStatus">現況登錄</a>
            </li>
            <li>
                <a class="nav-link" href="#InquireStatus">狀態查詢</a>
            </li>
            <li>
                <a class="nav-link" href="#Log">歷史紀錄</a>
            </li>
            <li>
                <a class="nav-link" href="#Repair">維修項目</a>
            </li>
            <li>
                <a class="nav-link" href="#MaintenanceCheck">儀器保養</a>
            </li>
            <li>
                <a class="nav-link" href="#DeviceManage">設備管理</a>
            </li>
            <li>
                <a class="nav-link" href="#UserManage">帳號管理</a>
            </li>
            <li>
                <a class="nav-link" href="#ChangePw">更改密碼</a>
            </li>
        </ul>
        <ul class="nav navbar-nav ml-auto">
            <li>
                <a class="nav-link" onclick="location.replace('login.html')">登入/登出</a>
            </li>
        </ul>
    </div>
</nav>
<div id="middle">
    <div class="container">
        <div w3-include-html="alert.html"></div>

        <div id="Content_Dashboard">1</div>
        <div id="Content_Enter_status">2</div>
        <div id="Content_Inquire_status">3</div>
        <div id="Content_Log">4</div>
        <div id="Content_Fix">5</div>
        <div id="Content_Maintenance_check">6</div>
        <div id="Content_Device_manage">7</div>
        <div id="Content_User_manage">8</div>
        <div id="Content_Change_pw">
            <div class="row" id="row-fgtpw">
                <div class="card" id="Fgtpw_HasToken" style="width: 450px">
                    <div class="card-header">
                        <h2 class="card-title">重設密碼</h2>
                    </div>
                    <div class="card-body">
                        <form role="form" class="form-my" id="form-HasToken">
                            <div class="form-group">
                                <label for="InputOldPw">帳號</label>
                                <input type="text" class="form-control-plaintext" id="ShowAcc" readonly >
                            </div>
                            <div class="form-group">
                                <label for="InputNewPw">新密碼</label>
                                <input type="password" class="form-control" id="InputNewPw_f" placeholder="請輸入新密碼" required>
                            </div>
                            <div class="form-group">
                                <label for="InputNewPwRe">確認新密碼</label>
                                <input type="password" class="form-control" id="InputNewPwRe_f" placeholder="請再次輸入新密碼" required>
                            </div>
                            <button type="submit" class="btn btn-default btn-primary btn-block" style="margin-top: 8px">送出</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="row" id="row-chgpw">
                <div class="col-md-6">
                    <div class="card" id="Chgpw">
                        <div class="card-header">
                            <h2 class="card-title">更改密碼</h2>
                        </div>
                        <div class="card-body">
                            <form role="form" class="form-my" id="form-Chgpw">
                                <div class="form-group">
                                    <label for="InputOldPw">帳號</label>
                                    <input type="text" class="form-control" id="InputAcc" placeholder="請輸入帳號" required>
                                </div>
                                <div class="form-group">
                                    <label for="InputOldPw">舊密碼</label>
                                    <input type="password" class="form-control" id="InputOldPw" placeholder="請輸入舊密碼" required>
                                </div>
                                <div class="form-group">
                                    <label for="InputNewPw">新密碼</label>
                                    <input type="password" class="form-control" id="InputNewPw" placeholder="請輸入新密碼" required>
                                </div>
                                <div class="form-group">
                                    <label for="InputNewPwRe">確認新密碼</label>
                                    <input type="password" class="form-control" id="InputNewPwRe" placeholder="請再次輸入新密碼" required>
                                </div>
                                <button type="submit" class="btn btn-default btn-primary btn-block" style="margin-top: 8px">送出</button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card" id="Fgtpw_GetToken">
                        <div class="card-header">
                            <h2 class="card-title">忘記密碼</h2>
                        </div>
                        <div class="card-body">
                            <form role="form" class="form-my" id="form-GetToken">
                                <div class="form-group">
                                    <label for="InputEmail">請輸入您註冊的E-mail</label>
                                    <input type="email" class="form-control" id="InputEmail" placeholder="請輸入E-mail" required>
                                </div>
                                <button type="submit" class="btn btn-default btn-primary btn-block" style="margin-top: 8px">送出</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        OnHashchangeListener();
        $(".nav a").on("click", function () {
            $(".nav").find(".active").removeClass("active");
            $(this).parent().addClass("active");
            $("#navbarToggler").collapse('hide');
        });

        FormSubmitListener();

        window.addEventListener('hashchange', OnHashchangeListener);
    });

    function OnHashchangeListener() {
        var hash = location.hash;
        console.log(hash);
        if (hash != '') {
            $(".nav").find(".active").removeClass("active");
            $("a[href='" + hash + "']").parent().addClass('active');
        }
        change_pages(hash);
        HideAlert();
        if (hash == '' && login_check()) {

        }
        if (hash == '#UpdateStatus' && login_check()) {

        }
        if (hash == '#InquireStatus' && login_check()) {

        }
        if (hash == '#Log' && login_check()) {

        }
        if (hash == '#Repair' && login_check()) {

        }
        if (hash == '#MaintenanceCheck' && login_check()) {

        }
        if (hash == '#DeviceManage' && login_check()) {

        }
        if (hash == '#UserManage' && login_check()) {

        }
        if (hash == '#ChangePw') {
            console.log(location.href);
            var getURl = new URL(location.href);
            if (getURl.searchParams.has('token')) {
                $('#row-fgtpw').show();
                $('#row-chgpw').hide();
                $.ajax({
                    url: "../ntuh_yl_RT_mdms_api/user.php",
                    data: "mode=rstpw_check&token=" + getURl.searchParams.get('token'),
                    type: "POST",
                    success: function (msg) {
                        smsg=msg.split(',');
                        if(smsg[0]=="token_ok"){
                            // TODO
                            $('#ShowAcc').val(smsg[1]);
                        }
                        if(smsg[0]=="token_timeout"){
                            ShowAlart('alert-danger',"連結已過期,請重新<a href='index.html#ChangePw' class='alert-link'>申請</a>!!",true,false);
                        }
                        if(smsg[0]=="hasnot_token"){
                            ShowAlart('alert-danger',"此連結無效,請重新<a href='index.html#ChangePw' class='alert-link'>申請</a>!!",true,false);
                        }
                    },
                    error: function (xhr) {
                        console.log('ajax er');
                        $.alert({
                            title: '錯誤',
                            content: 'Ajax 發生錯誤',
                            type: 'red',
                            typeAnimated: true
                        });
                    }
                });
            } else {
                $('#row-fgtpw').hide();
                $('#row-chgpw').show();
            }

            /*$('#alert-primary').show();
            $('#alert-success').show();
            $('#alert-danger').show();
            $('#alert-warning').show();
            $('#alert-info').show();*/
        }
    }

    function login_check() {
        if ($.cookie('LoginInfoAcc')) {
            return true;
        } else if (location.hash == '') {
            ShowAlart('alert-warning',"請先<a href='login.html' class='alert-link'>登入</a>",true,false);
            /*$('#alert-warning-in').html("請先<a href='login.html' class='alert-link'>登入</a>");
            $('#alert-warning').show();*/
        } else {
            ShowAlart('alert-danger','尚未登入!!',false,false);
            /*$('#alert-danger-in').text('尚未登入!!');
            $('#alert-danger').show();*/
            return false;
        }
    }

    function change_pages(hash) {
        $("div[id^='Content_']").hide();

        if (hash == '')
            $('#Content_Dashboard').show();
        if (hash == '#UpdateStatus')
            $('#Content_Enter_status').show();
        if (hash == '#InquireStatus')
            $('#Content_Inquire_status').show();
        if (hash == '#Log')
            $('#Content_Log').show();
        if (hash == '#Repair')
            $('#Content_Fix').show();
        if (hash == '#MaintenanceCheck')
            $('#Content_Maintenance_check').show();
        if (hash == '#DeviceManage')
            $('#Content_Device_manage').show();
        if (hash == '#UserManage')
            $('#Content_User_manage').show();
        if (hash == '#ChangePw')
            $('#Content_Change_pw').show();
    }

    function FormSubmitListener(){
        $('#form-HasToken').submit(function () {
            HideAlert();
            var npw=$('#InputNewPw_f').val();
            var npwr=$('#InputNewPwRe_f').val();
            if(npw=="" || npwr==""){
                $.alert({
                    title: '錯誤',
                    content: '新密碼或確認新密碼未輸入!!請再試一次',
                    type: 'red',
                    typeAnimated: true
                });
            }else if(npw!=npwr){
                $('#InputNewPw_f').val('');
                $('#InputNewPwRe_f').val('');
                $.alert({
                    title: '錯誤',
                    content: '確認新密碼不符合!!請再試一次',
                    type: 'red',
                    typeAnimated: true
                });
            }else{
                $('#InputNewPw_f').val('');
                $('#InputNewPwRe_f').val('');
                $.ajax({
                    url: "../ntuh_yl_RT_mdms_api/user.php",
                    data: "mode=rstpw_check&token=" + getURl.searchParams.get('token'),
                    type: "POST",
                    success: function (msg) {

                    },
                    error: function (xhr) {
                        console.log('ajax er');
                        $.alert({
                            title: '錯誤',
                            content: 'Ajax 發生錯誤',
                            type: 'red',
                            typeAnimated: true
                        });
                    }
                });
            }

            return false;
        });
        $('#form-Chgpw').submit(function () {
            HideAlert();

            return false;
        });
        $('#form-GetToken').submit(function () {
            HideAlert();

            return false;
        });
    }

    w3.includeHTML();
</script>
</body>
</html>